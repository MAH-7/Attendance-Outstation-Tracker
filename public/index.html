<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>JPKTimur Tracker</title>
    <link rel="stylesheet" href="style.css" />
    <script src="/socket.io/socket.io.js"></script>
    <script>
      function toggleFields() {
        const status = document.getElementById("status").value;
        const checkInTime = document.getElementById("check-in-time");
        const destinationFields = document.getElementById("destination-fields");
        const pinInput = document.getElementById("pin");

        if (status === "Present") {
          checkInTime.style.display = "block";
          destinationFields.style.display = "none";
          pinInput.required = false; // Remove required when "Present"
          pinInput.value = ""; // Clear PIN input
        } else if (status === "Outstation") {
          checkInTime.style.display = "none";
          destinationFields.style.display = "block";
          pinInput.required = true; // Set required when "Outstation"
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        document
          .getElementById("status")
          .addEventListener("change", toggleFields);
        toggleFields(); // On page load, call it to set initial state

        // Download reports functionality
        document.getElementById('download-btn').addEventListener('click', openDownloadModal);
      });

      function openDownloadModal() {
        document.getElementById('download-modal').style.display = 'block';

        // Populate month selector with current and previous months
        const monthSelect = document.getElementById('month-select');
        const currentDate = new Date();

        // Clear existing options
        monthSelect.innerHTML = '';

        // Add last 12 months
        for (let i = 0; i < 12; i++) {
          const date = new Date(currentDate.getFullYear(), currentDate.getMonth() - i, 1);
          const monthValue = date.getFullYear() + '-' + String(date.getMonth() + 1).padStart(2, '0');
          const monthText = date.toLocaleDateString('en-MY', { year: 'numeric', month: 'long' });

          const option = document.createElement('option');
          option.value = monthValue;
          option.textContent = monthText;
          monthSelect.appendChild(option);
        }
      }

      function closeDownloadModal() {
        document.getElementById('download-modal').style.display = 'none';
      }

      async function downloadReport() {
        const month = document.getElementById('month-select').value;
        const format = document.querySelector('input[name="format"]:checked').value;

        if (!month || !format) {
          alert('Please select both month and format');
          return;
        }

        try {
          const response = await fetch(`/api/download-report?month=${month}&format=${format}`);

          if (!response.ok) {
            throw new Error('Failed to generate report');
          }

          const blob = await response.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.style.display = 'none';
          a.href = url;
          a.download = `attendance-report-${month}.${format === 'excel' ? 'xlsx' : 'pdf'}`;
          document.body.appendChild(a);
          a.click();
          window.URL.revokeObjectURL(url);

          closeDownloadModal();
          alert('Report downloaded successfully!');
        } catch (error) {
          alert('Error downloading report: ' + error.message);
        }
      }
    </script>
  </head>
  <body>
    <a href="./dashboard.html" class="link">Dashboard</a>
    <button id="download-btn" class="link">Download Reports</button>
    <h1>JPKTimur Attendance & Outstation Tracker</h1>
    <section>
      <h2>Submit Attendance or Outstation</h2>
      <form id="attendance-form" action="/submit-attendance" method="POST">
        <label for="employee">Employee Name:</label>
        <input
          type="text"
          id="employee"
          name="employee"
          placeholder="Your Name"
          required
        />

        <label for="status">Status:</label>
        <select id="status" name="status" required>
          <option value="Present">In Office</option>
          <option value="Outstation">Outstation</option>
        </select>

        <div id="check-in-time">
          <label for="check_in_time">Clock-in Time:</label>
          <input type="time" id="check_in_time" name="check_in_time" />
        </div>

        <div id="destination-fields" style="display: none">
          <label for="destination">Destination (for Outstation):</label>
          <input
            type="text"
            id="destination"
            name="destination"
            placeholder="Destination"
          />
          <br />
          <label for="start-date">Start Date:</label>
          <input type="date" id="start-date" name="start_date" />
          <br />
          <label for="end-date">End Date:</label>
          <input type="date" id="end-date" name="end_date" />
          <br />
          <label for="pin">PIN (4-digit number):</label>
          <input
            type="text"
            id="pin"
            name="pin"
            placeholder="Enter 4-digit PIN"
            maxlength="4"
            pattern="^\d{4}$"
            required
          />
        </div>

        <button type="submit">Submit</button>
      </form>
      <h2>Submit Notice Board</h2>
      <form id="notice-form" action="/submit-notice" method="POST">
        <label for="title">Title:</label>
        <input
          type="text"
          id="title"
          name="title"
          placeholder="Title"
          required
          />
        <label for="notice">Notice:</label>
        <input
          type="text"
          id="notice"
          name="content"
          placeholder="Notice"
          required
        />
        <label for="notice-date">Date:</label>
        <input
          type="date"
          id="notice-date"
          name="notice_date"
          required
          />
        <button type="submit">Submit</button>
    </section>

    <section>
      <h2>Employees In Office</h2>
      <table>
        <thead>
          <tr>
            <th>Employee</th>
            <th>Clock-In Time</th>
            <th>Clock-Out Time</th>
          </tr>
        </thead>
        <tbody id="present-employees"></tbody>
      </table>

      <h2>Employees On Outstation</h2>
      <table>
        <thead>
          <tr>
            <th>Employee Name</th>
            <th>Destination</th>
            <th>Start Date</th>
            <th>End Date</th>
            <th>Number of Days</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="outstation-employees"></tbody>
      </table>
    </section>

    <!-- Download Reports Modal - Moved outside form scope -->
    <div id="download-modal" class="modal" style="display: none;">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Download Attendance Report</h3>
          <span class="close" onclick="closeDownloadModal()">&times;</span>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="month-select">Select Month:</label>
            <select id="month-select">
              <!-- Options will be populated dynamically -->
            </select>
          </div>

          <div class="form-group">
            <label>Select Format:</label>
            <div class="radio-group">
              <label>
                <input type="radio" name="format" value="excel" checked>
                Excel (.xlsx)
              </label>
              <label>
                <input type="radio" name="format" value="pdf">
                PDF (.pdf)
              </label>
            </div>
          </div>

          <div class="form-group">
            <button onclick="downloadReport()" class="download-button">Generate & Download</button>
            <button onclick="closeDownloadModal()" class="cancel-button">Cancel</button>
          </div>
        </div>
      </div>
    </div>

    <script src="app.js"></script>
  </body>
</html>